# API Starter

Production‑ready Express + TypeScript starter with:
- Response envelopes and RFC 7807 error responses
- Correlation IDs and structured logging
- Validation (Zod), rate limiting, CORS, security headers
- Swagger docs, Prometheus metrics, health/readiness probes
- Prisma ORM with Postgres, cursor and page pagination

Tech stack
- Node.js + TypeScript
- Express 5
- Prisma + PostgreSQL
- Zod
- Winston
- Swagger (swagger-jsdoc + swagger-ui-express)
- Prometheus client

Project structure
```
src/
  app.ts                  -> Express app wiring
  server.ts               -> Server bootstrap
  api/                    -> Routers, controllers, services
    index.ts
    v1/users/             -> Users domain (routes, controller, service, repo)
  common/
    middlewares/          -> Cross-cutting middlewares (errors, CORS, rate limit, logging)
    utils/                -> Helpers (logger, response envelope, audit)
    monitoring/           -> Prometheus metrics
  config/env.ts           -> Env parsing/validation (Zod)
  docs/swagger.ts         -> Swagger spec
  infra/db/prisma.ts      -> Prisma client
prisma/                   -> Prisma schema and migrations
```

Key modules and symbols
- App bootstrap: [src/app.ts](src/app.ts)
  - Uses [`requestId`](src/common/middlewares/requestId.ts), [`httpLogger`](src/common/middlewares/httpLogger.ts), [`buildCors`](src/common/middlewares/cors.ts), [`generalLimiter`](src/common/middlewares/rateLimit.ts), [`speedLimiter`](src/common/middlewares/rateLimit.ts), [`errorHandler`](src/common/middlewares/errorHandler.ts)
  - Exposes /health, /readyz, /metrics, /docs
- Logger: [`logger`](src/common/utils/logger.ts)
- Response helpers: [`ok`](src/common/utils/response.ts), [`created`](src/common/utils/response.ts)
- Errors: [`AppError`](src/common/middlewares/AppError.ts), [`errorHandler`](src/common/middlewares/errorHandler.ts)
- Metrics: [`httpRequestDuration`](src/common/monitoring/metrics.ts), [`metricsMiddleware`](src/common/monitoring/metrics.ts)
- DB client: [`prisma`](src/infra/db/prisma.ts)

Users domain
- Routes: [src/api/v1/users/routes.ts](src/api/v1/users/routes.ts)
- Controller: [`list`](src/api/v1/users/controller.ts), [`get`](src/api/v1/users/controller.ts), [`create`](src/api/v1/users/controller.ts), [`update`](src/api/v1/users/controller.ts), [`remove`](src/api/v1/users/controller.ts)
- Service: [`getUsers`](src/api/v1/users/service.ts), [`countUsers`](src/api/v1/users/service.ts), [`getUser`](src/api/v1/users/service.ts), [`addUser`](src/api/v1/users/service.ts), [`editUser`](src/api/v1/users/service.ts), [`removeUser`](src/api/v1/users/service.ts), [`getUsersCursor`](src/api/v1/users/service.ts)
- Repository: [`listUsers`](src/api/v1/users/repository.ts), [`getUserById`](src/api/v1/users/repository.ts), [`createUser`](src/api/v1/users/repository.ts), [`updateUser`](src/api/v1/users/repository.ts), [`deleteUser`](src/api/v1/users/repository.ts), [`getUserByEmail`](src/api/v1/users/repository.ts), [`countUsers`](src/api/v1/users/repository.ts), [`listUsersCursor`](src/api/v1/users/repository.ts)
- Schemas: [src/api/v1/users/schema.ts](src/api/v1/users/schema.ts)
- Types: [src/api/v1/users/types.ts](src/api/v1/users/types.ts)

Getting started
1) Install
```sh
npm i
```
2) Configure environment
- Copy .env.example to .env and set values
- Required: PORT, NODE_ENV, JWT_SECRET; DATABASE_URL required in production (validated in [src/config/env.ts](src/config/env.ts))
3) Migrate database
```sh
npx prisma migrate dev
```
4) Run in dev
```sh
npm run dev
```
5) Build and run
```sh
npm run build && npm start
```

API documentation
- Swagger UI: GET /docs
- JSON: GET /docs.json (generated by [src/docs/swagger.ts](src/docs/swagger.ts))

Health and metrics
- Liveness: GET /health
- Readiness (DB): GET /readyz (checks [`prisma`](src/infra/db/prisma.ts))
- Prometheus metrics: GET /metrics (via [`metricsMiddleware`](src/common/monitoring/metrics.ts))

Response envelope
- Success: { traceId, data, meta? } (see [`ok`](src/common/utils/response.ts), [`created`](src/common/utils/response.ts))
- Error: RFC 7807 Problem Details (via [`errorHandler`](src/common/middlewares/errorHandler.ts))
- Correlation: X-Request-Id header and res.locals.requestId from [`requestId`](src/common/middlewares/requestId.ts)

Validation
- Body validation: [`validate`](src/common/middlewares/validate.ts)
- Params/query validation: [`validateRequest`](src/common/middlewares/validateRequest.ts)

Logging
- Request logging: [`httpLogger`](src/common/middlewares/httpLogger.ts) adds traceId
- App logs: [`logger`](src/common/utils/logger.ts) uses JSON in production

Security and limits
- CORS: [`buildCors`](src/common/middlewares/cors.ts) from ENV.CORS_ORIGIN
- Rate limit: [`generalLimiter`](src/common/middlewares/rateLimit.ts), [`sensitiveLimiter`](src/common/middlewares/rateLimit.ts), [`speedLimiter`](src/common/middlewares/rateLimit.ts)
- Headers: helmet in [src/app.ts](src/app.ts)

Users API quick reference
- List: GET /api/v1/users?page=1&limit=20 or GET /api/v1/users?cursor=<uuid>&limit=10
- Get: GET /api/v1/users/{id}
- Create: POST /api/v1/users { name, email }
- Update: PATCH /api/v1/users/{id} { name?, email? }
- Delete: DELETE /api/v1/users/{id}

Examples
List (paged):
```sh
curl -s 'http://localhost:3000/api/v1/users?page=1&limit=10'
```
Create:
```sh
curl -s -X POST 'http://localhost:3000/api/v1/users' \
  -H 'Content-Type: application/json' \
  -d '{"name":"Ada Lovelace","email":"ada@example.com"}'
```

Development scripts
- Dev: npm run dev
- Build: npm run build
- Start: npm start
- Test: npm test
- Lint/format: npm run lint / npm run format

Database
- Prisma schema: [prisma/schema.prisma](prisma/schema.prisma) (User with @updatedAt)
- Generated client: [src/generated/prisma](src/generated/prisma) (ignored by git)
- Client setup and logging: [`prisma`](src/infra/db/prisma.ts)

Notes
- Problem mapping for Prisma errors (e.g. P2002 unique constraint) is handled in [`errorHandler`](src/common/middlewares/errorHandler.ts).
- Controllers add Cache-Control for cacheable GETs ([`list`](src/api/v1/users/controller.ts), [`get`](src/api/v1/users/controller.ts)).
- Known TODO: add graceful shutdown to [src/server.ts](src/server.ts) and switch console.log to [`logger`](src/common/utils/logger.ts).


# Architecture

Layers
- API (Routers): route definitions and validation wiring. See [src/api/index.ts](../src/api/index.ts), [src/api/v1/users/routes.ts](../src/api/v1/users/routes.ts).
- Controller: translate HTTP to service calls; sets caching, envelopes, auditing. See [src/api/v1/users/controller.ts](../src/api/v1/users/controller.ts).
- Service: business rules, conflict checks, existence checks (throws [`AppError`](../src/common/middlewares/AppError.ts)). See [src/api/v1/users/service.ts](../src/api/v1/users/service.ts).
- Repository: DB access via Prisma. See [src/api/v1/users/repository.ts](../src/api/v1/users/repository.ts).
- Infra: Prisma client setup. See [src/infra/db/prisma.ts](../src/infra/db/prisma.ts).
- Cross-cutting: middlewares, logging, metrics, errors. See [src/common](../src/common).

Request flow
1) Incoming request → [`requestId`](../src/common/middlewares/requestId.ts) assigns traceId
2) [`httpLogger`](../src/common/middlewares/httpLogger.ts) logs request line with traceId
3) Security and platform middleware: helmet, CORS via [`buildCors`](../src/common/middlewares/cors.ts), JSON body limit
4) Rate limiting: [`generalLimiter`](../src/common/middlewares/rateLimit.ts), [`speedLimiter`](../src/common/middlewares/rateLimit.ts)
5) Route handlers with validation: [`validate`](../src/common/middlewares/validate.ts) / [`validateRequest`](../src/common/middlewares/validateRequest.ts)
6) Controllers call services/repos; responses via [`ok`](../src/common/utils/response.ts)/[`created`](../src/common/utils/response.ts)
7) Errors bubble to [`errorHandler`](../src/common/middlewares/errorHandler.ts) → RFC7807

Error handling
- Use [`AppError`](../src/common/middlewares/AppError.ts) for expected errors (404, 409, etc.)
- Prisma known errors (e.g., P2002) → mapped to 409 in [`errorHandler`](../src/common/middlewares/errorHandler.ts)

Observability
- Logging: [`logger`](../src/common/utils/logger.ts) (JSON in prod)
- Metrics: latency histogram via [`httpRequestDuration`](../src/common/monitoring/metrics.ts)
- Auditing: [`audit`](../src/common/utils/audit.ts) from controllers

Performance and reliability
- Cache-Control headers for GET list/get in controller
- Readiness probe `/readyz` runs lightweight DB check
- ETags or conditional GETs can be added on cacheable resources

Security
- CORS configured from ENV
- Rate limits: general and stricter for mutations (`sensitiveLimiter` ready to use)
- Helmet provides sane defaults

Data model
- User: see [prisma/schema.prisma](../prisma/schema.prisma)
- Migrations under [prisma/migrations](../prisma/migrations)

Conventions
- Response shape: `{ traceId, data, meta? }`
- Errors: RFC 7807
- Pagination: page/limit or cursor/limit, meta includes `pagination` or `cursor`